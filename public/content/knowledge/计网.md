## HTTP 协议演进

### HTTP/1.1 的主要特性

1. **持久连接**

   - 通过使用持久连接来使多个 HTTP 请求复用同一个 TCP 连接
   - 避免使用非持久连接时每次需要建立连接的时延

2. **资源请求优化**

   - 允许只请求资源的某个部分
   - 更好地利用带宽和连接

3. **缓存控制增强**

   - 引入了更多的缓存控制策略
   - 新增 ETag、If-Match、If-None-Match 等缓存头

4. **Host 字段**

   - 新增 host 字段
   - 可以将请求发往同一台服务器上的不同网站

5. **请求方法扩展**

   - 新增 OPTIONS、PUT、DELETE、TRACE、CONNECT 方法

6. **管道网络传输**

   - 支持请求管道化
   - 第一个请求发出后，不必等其回来就可以发送第二个请求
   - 减少整体响应时间

7. **存在的问题**
   - 头部未压缩，以纯文本形式传输导致冗余
   - Cookie 等头部在每次请求中重复发送
   - 无服务器推送能力

### HTTP/2.0 的改进

1. **二进制协议**

   - HTTP/2 是一个完全的二进制协议
   - 头信息和数据体都是二进制，统称为"帧"
   - 可分为头信息帧和数据帧
   - 帧的概念是实现多路复用的基础

2. **多路复用**

   - 在一个连接里，客户端和服务器可以同时发送多个请求或响应
   - 不用按照顺序一一对应
   - 避免了"队头堵塞"问题

3. **数据流**

   - 引入数据流的概念
   - 每个请求或响应的所有数据包称为一个数据流
   - 每个数据流都有唯一编号
   - 所有数据包都必须标记数据流 ID

4. **头信息压缩**

   - 使用 HPACK 算法压缩头部
   - 客户端和服务器同时维护一张头信息表
   - 相同的字段只发送索引号
   - 显著提高传输效率

5. **服务器推送**
   - 服务器可以主动向客户端推送资源
   - 提前推送必要的静态资源
   - 减少延迟时间
   - 注意：这与 WebSocket 和 SSE 的推送机制不同

### HTTP 缓存相关请求头

#### 强缓存

1. **Expires (HTTP/1.0)**

   - HTTP/1.0 的标准
   - 使用服务器时区可能导致时区不一致问题
   - 在 HTTP/1.1 中建议使用 Cache-Control 替代

2. **Cache-Control (HTTP/1.1)**
   - HTTP/1.1 引入的更精确的缓存控制机制
   - 主要指令：
     - `max-age=<seconds>`：指定缓存最大有效时间
     - `no-cache`：强制验证资源是否更改
     - `no-store`：禁止缓存
     - `public`：允许所有用户缓存
     - `private`：仅允许单个用户缓存

#### 协商缓存

1. **Last-Modified/If-Modified-Since (HTTP/1.0)**

   - 基于资源修改时间的缓存策略

2. **ETag/If-None-Match (HTTP/1.1)**
   - 服务器生成的资源唯一标识符
   - 可以是哈希值或其他标识字符串
   - 客户端通过 If-None-Match 头部验证资源是否变化

### HTTP/3 特性

1. **基于 UDP 的优势**
   - 更低的延迟：避免 TCP 三次握手
   - 0-RTT 连接建立
   - 解决队头阻塞问题
   - 更高效的丢包恢复
   - 内建加密机制
   - 更好的网络切换支持
   - 优化的带宽利用率

### HTTP 请求方法

1. **GET**：获取数据
2. **POST**：提交数据，可能修改服务器资源
3. **PUT**：上传文件，更新数据
4. **DELETE**：删除服务器对象
5. **HEAD**：仅获取报文首部
6. **OPTIONS**：获取支持的请求方法
7. **CONNECT**：建立代理隧道通信
8. **TRACE**：回显服务器收到的请求

### 输入 URL 发生的过程

1. **URL 解析**

   - 解析协议和资源路径
   - 检查 URL 合法性
   - 转义非法字符

2. **缓存检查**

   - 检查请求资源是否在缓存中
   - 验证缓存是否有效

3. **DNS 解析**

   - 检查本地 DNS 缓存
   - 向本地 DNS 服务器发起请求
   - 递归查询过程
   - 获取目标 IP 地址

4. **获取 MAC 地址**

   - 判断是否在同一子网
   - 使用 ARP 协议获取 MAC 地址
   - 必要时获取网关 MAC 地址

5. **TCP 三次握手**

   - 客户端发送 SYN 请求
   - 服务器回应 SYN+ACK
   - 客户端发送 ACK 确认

6. **HTTPS 握手（如果使用 HTTPS）**

   - 协议版本协商
   - 加密方法选择
   - 证书验证
   - 密钥交换

7. **数据传输**

   - 服务器返回 HTML 文件
   - 浏览器接收响应

8. **页面渲染**

   - 构建 DOM 树
   - 构建 CSSOM 树
   - 处理 JavaScript
   - 生成渲染树
   - 布局和绘制

9. **TCP 四次挥手**
   - 客户端发起连接释放请求
   - 服务器确认并等待发送完数据
   - 服务器发送连接释放请求
   - 客户端确认，等待 2MSL 后关闭

### WebSocket

#### 概述

WebSocket 是 HTML5 提供的全双工通讯技术，具有以下特点：

- 支持双向实时通信
- 可发送文本和二进制数据
- 建立在 TCP 协议之上
- 数据格式轻量，性能开销小
- 无同源限制
- 使用 ws/wss 协议
- 与 HTTP 协议兼容
- 默认端口 80/443

#### 应用场景

- 弹幕系统
- 实时聊天
- 多媒体通信

### TCP/IP 五层协议

1. **应用层**

   - 为应用进程提供服务
   - 主要协议：HTTP、FTP、SMTP、DNS

2. **传输层**

   - TCP：面向连接的可靠传输
   - UDP：无连接的尽力传输

3. **网络层**

   - 负责主机间通信
   - 路由选择

4. **数据链路层**

   - 封装 IP 数据报
   - 处理帧传输

5. **物理层**
   - 提供物理传输环境
   - 确保数据传输可靠性

### TCP 和 UDP 对比

#### UDP 特点

1. **面向无连接**

   - 无需建立连接即可传输
   - 不对数据报文进行拆分/拼接

2. **传输特性**

   - 支持单播、多播、广播
   - 面向报文
   - 保留报文边界

3. **可靠性**

   - 不保证可靠传输
   - 无拥塞控制
   - 适合实时性要求高的场景

4. **效率**
   - 头部开销小（8字节）
   - 传输效率高

#### TCP 特点

1. **面向连接**

   - 传输前需三次握手
   - 仅支持点对点传输

2. **传输特性**

   - 面向字节流
   - 不保留报文边界
   - 可靠传输

3. **流控制与拥塞控制**

   - 提供流量控制
   - 具有拥塞控制机制
   - 保证网络稳定性

4. **通信方式**
   - 支持全双工通信
   - 两端都有缓存

### 同源策略与跨域

#### 同源策略

浏览器的核心安全机制，要求以下三个要素必须相同：

- 协议（HTTP/HTTPS）
- 域名（或IP地址）
- 端口号

#### 限制行为

1. 禁止跨域资源访问

   - AJAX 请求限制
   - fetch/XMLHttpRequest 限制

2. 限制敏感数据操作

   - Cookie 访问限制
   - LocalStorage 访问限制
   - DOM 操作限制

3. 安全防护
   - 防范 CSRF 攻击
   - 防范 XSS 攻击

#### 跨域解决方案

1. **CORS**

   - 服务器配置响应头
   - 声明允许的跨域访问源

2. **代理服务器**

   - 使用同源代理服务器
   - 转发跨域请求

3. **WebSocket**
   - 适用于实时通信
   - 不受同源策略限制
